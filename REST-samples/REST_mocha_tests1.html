<html>
<head>
	<meta charset="utf-8">
	<title>Mocha Tests</title>
	<link href="https://cdn.rawgit.com/mochajs/mocha/2.2.5/mocha.css" rel="stylesheet" />
</head>

<body>
	<div id="mocha"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://js.stripe.com/v2/"></script>

    <script src="https://cdn.rawgit.com/mochajs/mocha/2.2.5/mocha.js"></script>
    <script src="http://chaijs.com/chai.js"></script>

	<script>

        // the api callers
        var TIMEOUT_MS = 10000;
        var ENDPOINT = 'https://paym6-dev-developer-edition.na35.force.com/h/services/apexrest/v1';
        var PUBLISHABLE_KEY = 'pk_test_rx6uxcAgv6PZM2LuH7TL9imW';

        var CC_HOLDER_NAME = "Holder Maki";
        var CC_NUMBER = "4242424242424242";
        var CC_CVC = "123";
        var EXP_MONTH = "5";
        var EXP_YEAR = "2019";

        var ADDRESS_CITY = "Budapest";
        var ADDRESS_LINE1 = "Add l. 1";
        var ADDRESS_ZIP = "1234";
        var ADDRES_COUNTRY = "Hungary";
        var CUSTOMER_EMAIL = "maki@gmail.com";

        var PAYMENT_GATEWAY_ID = "a0141000001jhohAAA";
        var CONTACT_ID = "00341000003ftLmAAI";
        var ACCOUNT_ID = "00141000004fyVJAAY";
        var CUSTOMER_ID = "a0741000002RrjOAAS";

        var FAULTY_CVC_CARD = '4000000000000127';
        var FAULTY_EXPIRED_CARD = '4000000000000069';
        var FAULTY_PROCESSING_ERROR_CARD = '4000000000000119';
        var FAULTY_INCORRECT_NUMBER_CARD = '4242424242424241';
        var FAULTY_FAILED_TRANSCTIONS_CARD = '4000000000000341';


        var getTokenAndCallREST_API = function(d, callback, alternate_cc_number) {
            Stripe.setPublishableKey(PUBLISHABLE_KEY);

            var cc_number = CC_NUMBER;
            if (alternate_cc_number) {
                cc_number = alternate_cc_number;
            }

            Stripe.card.createToken({
                number: cc_number,
                cvc: CC_CVC,
                exp_month: EXP_MONTH,
                exp_year: EXP_YEAR,
                name: CC_HOLDER_NAME,
                address_line1: ADDRESS_LINE1,
                address_city: ADDRESS_CITY, 
                address_zip: ADDRESS_ZIP,
                address_country: ADDRES_COUNTRY
            }, function(status, response) {
                if (response.error) {
                    throw "Something went wrong when getting token from Stripe " + response.error.message;
                }
                d.stripePayload = JSON.stringify(response);
                callREST_API(d, callback);             
            });
        }

        var callREST_API = function(d, callback) {

            console.log('## callREST_API', d);
            $.ajax({
                type : 'POST',
                url : ENDPOINT,
                headers : {
                    "content-type": "text/plain"
                },
                data : JSON.stringify(d),
                success : callback
            }); 
        }
        

        // the test cases
        mocha.setup('bdd');
        var should = chai.should();
        var expect = chai.expect;

        describe("p360 REST API test #1", function() {

            describe("Error handling on init", function() {

                it("Error: Should throw an error on a missing action param", function(done) {

                    var d = {
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("action");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });
                }).timeout(TIMEOUT_MS);

                it("Error: Should throw an error on an unknown action param", function(done) {

                    var d = {
                        "action" : "x"
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("action");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });
                }).timeout(TIMEOUT_MS);

            });



            describe("createPaymentMethod action tests", function() {
                it("Error: Should throw an error on a broken accountId param", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "accountId" : "xx"
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("accountId");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Error: Should throw an error on a broken contactId param", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "contactId" : "xx"
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("contactId");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);


                it("Error: Should throw an error on a broken customerId param", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "customerId" : "xx"
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("customerId");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Error: Missing paymentGatewayId", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("paymentGatewayId");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Error: Missing stripePayload", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    callREST_API(d, function(r) {
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal("stripePayload");
                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, no other parameters.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");

                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, publishableKey set, no other parameters.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "publishableKey" : PUBLISHABLE_KEY
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");

                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, setting an email on customer.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "email" : CUSTOMER_EMAIL
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");

                            r.paymentMethodList[0].customerId.should.not.equal(null);
                            r.paymentMethodList[0].email.should.equal(CUSTOMER_EMAIL);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, connect to a Customer.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "customerId" : CUSTOMER_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);       

                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.equal(CUSTOMER_ID);

                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, connect to a Contact.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "contactId" : CONTACT_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);       

                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");

                            r.paymentMethodList[0].customerId.should.not.equal(null);
                            r.paymentMethodList[0].contactId.should.equal(CONTACT_ID);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);


                it("Success: Stripe payload, paymentGatewayId set, connect to a Account.", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "accountId" : ACCOUNT_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);       

                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");

                            r.paymentMethodList[0].customerId.should.not.equal(null);
                            r.paymentMethodList[0].accountId.should.equal(ACCOUNT_ID);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, 1 transaction to charge, with due date", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 100,
                                "dueDate" : "2019-05-17"
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);
                            r.transactionList[0].amount.should.equal(100);
                            r.transactionList[0].dueDate.should.equal('2019-05-17');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].paymentStatus.should.equal('Captured');
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Completed');

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);
            
                it("Success: Stripe payload, paymentGatewayId set, 2 transactions to charge", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 100,
                                "dueDate" : "2019-05-17"
                            },
                            {
                                "amount" : 200,
                                "dueDate" : "2019-01-01"
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(2);
                            r.transactionList[0].amount.should.equal(100);
                            r.transactionList[0].dueDate.should.equal('2019-05-17');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].paymentStatus.should.equal('Captured');
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Completed');

                            r.transactionList[1].amount.should.equal(200);
                            r.transactionList[1].dueDate.should.equal('2019-01-01');
                            r.transactionList[1].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[1].paymentStatus.should.equal('Captured');
                            r.transactionList[1].transactionId.should.not.equal(null);
                            r.transactionList[1].transactionStatus.should.equal('Completed');

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, 1 transaction to open only, with due date", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 100,
                                "dueDate" : "2019-12-31",
                                "openOnly" : true
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);
                            r.transactionList[0].amount.should.equal(100);
                            r.transactionList[0].dueDate.should.equal('2019-12-31');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Open');
                            expect(r.transactionList[0].paymentStatus).to.equal(null);
                            r.transactionList[0].openOnly.should.equal(true);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, 2 transactions to open only, with due date", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 999,
                                "dueDate" : "2019-12-31",
                                "openOnly" : true
                            },
                            {
                                "amount" : 11,
                                "openOnly" : true
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(2);

                            r.transactionList[0].amount.should.equal(999);
                            r.transactionList[0].dueDate.should.equal('2019-12-31');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Open');
                            expect(r.transactionList[0].paymentStatus).to.equal(null);
                            r.transactionList[0].openOnly.should.equal(true);

                            r.transactionList[1].amount.should.equal(11);
                            expect(r.transactionList[1].dueDate).to.equal(null);
                            r.transactionList[1].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[1].transactionId.should.not.equal(null);
                            r.transactionList[1].transactionStatus.should.equal('Open');
                            expect(r.transactionList[1].paymentStatus).to.equal(null);
                            r.transactionList[1].openOnly.should.equal(true);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);

                it("Success: Stripe payload, paymentGatewayId set, one transaction to charge, one to open", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 999,
                            },
                            {
                                "amount" : 11,
                                "openOnly" : true
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(2);

                            r.transactionList[0].amount.should.equal(999);
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Completed');
                            r.transactionList[0].paymentStatus.should.equal('Captured');
                            expect(r.transactionList[0].openOnly).to.not.equal(true);

                            r.transactionList[1].amount.should.equal(11);
                            expect(r.transactionList[1].dueDate).to.equal(null);
                            r.transactionList[1].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[1].transactionId.should.not.equal(null);
                            r.transactionList[1].transactionStatus.should.equal('Open');
                            expect(r.transactionList[1].paymentStatus).to.equal(null);
                            r.transactionList[1].openOnly.should.equal(true);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);


                it("Success: Stripe payload, paymentGatewayId set, 1 transaction to auth only", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 111,
                                "dueDate" : "2019-1-1",
                                "authOnly" : true
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);
                            r.transactionList[0].amount.should.equal(111);
                            r.transactionList[0].dueDate.should.equal('2019-01-01');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Completed');
                            r.transactionList[0].paymentStatus.should.equal('Authorized');
                            r.transactionList[0].openOnly.should.equal(false);
                            r.transactionList[0].authOnly.should.equal(true);


                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);


                it("Success: Stripe payload, paymentGatewayId set, 1 transaction to auth only, 1 to open, 1 to charge", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 111,
                                "dueDate" : "2019-1-1",
                                "authOnly" : true
                            },
                            {
                                "amount" : 55,
                                "dueDate" : "2019-3-3",
                                "openOnly" : true
                            },
                            {
                                "amount" : 77,
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);
                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(3);
                            
                            r.transactionList[0].amount.should.equal(111);
                            r.transactionList[0].dueDate.should.equal('2019-01-01');
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Completed');
                            r.transactionList[0].paymentStatus.should.equal('Authorized');
                            r.transactionList[0].openOnly.should.equal(false);
                            r.transactionList[0].authOnly.should.equal(true);

                            r.transactionList[1].amount.should.equal(55);
                            r.transactionList[1].dueDate.should.equal('2019-03-03');
                            r.transactionList[1].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[1].transactionId.should.not.equal(null);
                            r.transactionList[1].transactionStatus.should.equal('Open');
                            expect(r.transactionList[1].paymentStatus).to.equal(null);
                            r.transactionList[1].openOnly.should.equal(true);

                            r.transactionList[2].amount.should.equal(77);
                            expect(r.transactionList[2].dueDate).to.equal(null);
                            r.transactionList[2].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[2].paymentStatus.should.equal('Captured');
                            r.transactionList[2].transactionId.should.not.equal(null);
                            r.transactionList[2].transactionStatus.should.equal('Completed');


                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS);


            });

            describe("Faulty PM / transaction data", function() {
                it("Fail: Stripe payload with a faulty CVC test card", function(done) {

                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal('cvc');

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_CVC_CARD.substr(FAULTY_CVC_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Invalid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);


                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_CVC_CARD);                    
                }).timeout(TIMEOUT_MS);

                it("Fail: Stripe payload with an expired test card", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal('exp_month');

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_EXPIRED_CARD.substr(FAULTY_EXPIRED_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Invalid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);


                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_EXPIRED_CARD);                    
                }).timeout(TIMEOUT_MS);

                it("Fail: Stripe payload with a processing error test card", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_PROCESSING_ERROR_CARD.substr(FAULTY_PROCESSING_ERROR_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Invalid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);


                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_PROCESSING_ERROR_CARD);                    
                }).timeout(TIMEOUT_MS); 


                it("Fail: Transaction can't go through if the CC is declined", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 100
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorParam.should.equal('exp_month');

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_EXPIRED_CARD.substr(FAULTY_EXPIRED_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Invalid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);
                            
                            r.transactionList[0].amount.should.equal(100);
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Open');
                            r.transactionList[0].errorMessage.should.not.equal(null);

                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_EXPIRED_CARD);                    
                }).timeout(TIMEOUT_MS);

                it("Success: Failed transactions card can go through WITHOUT a transaction", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(true);

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_FAILED_TRANSCTIONS_CARD.substr(FAULTY_FAILED_TRANSCTIONS_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Valid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);


                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_FAILED_TRANSCTIONS_CARD);                    
                }).timeout(TIMEOUT_MS); 

                it("Fail: CC goes through, but transaction is declined", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 55
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorMessage.should.not.equal(null);

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(FAULTY_FAILED_TRANSCTIONS_CARD.substr(FAULTY_FAILED_TRANSCTIONS_CARD.length-4));
                            r.paymentMethodList[0].status.should.equal('Valid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);

                            r.transactionList[0].amount.should.equal(55);
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Failed');
                            expect(r.transactionList[0].errorMessage).to.equal(null);



                            done();
                        } catch(e) {
                            done(e);
                        }
                    }, FAULTY_FAILED_TRANSCTIONS_CARD);                    
                }).timeout(TIMEOUT_MS); 

                it("Fail: CC goes through, but transaction is faulty (0 amount)", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 0
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorMessage.should.not.equal(null);

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].status.should.equal('Valid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(1);

                            r.transactionList[0].amount.should.equal(0);
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Failed');
                            expect(r.transactionList[0].errorMessage).to.equal(null);



                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS); 

                it("Fail: CC goes through, but one transaction is broken (0 amount), one goes through", function(done) {
                    var d = {
                        "action" : "createPaymentMethod",
                        "paymentGatewayId" : PAYMENT_GATEWAY_ID,
                        "transactionList" : [
                            {
                                "amount" : 0
                            },
                            {
                                "amount" : 66
                            }
                        ]
                    };

                    getTokenAndCallREST_API(d, function(r) {
                        console.log("r:", r);
                        try {
                            r.success.should.equal(false);
                            r.errorMessage.should.not.equal(null);

                            r.paymentMethodList.length.should.equal(1);                            
                            r.paymentMethodList[0].addressCity.should.equal(ADDRESS_CITY);
                            r.paymentMethodList[0].addressCountry.should.equal(ADDRES_COUNTRY);
                            r.paymentMethodList[0].addressPostalCode.should.equal(ADDRESS_ZIP);
                            r.paymentMethodList[0].brand.should.equal("Visa");
                            r.paymentMethodList[0].expMonth.should.equal(EXP_MONTH);
                            r.paymentMethodList[0].expYear.should.equal(EXP_YEAR);
                            r.paymentMethodList[0].holderName.should.equal(CC_HOLDER_NAME);
                            r.paymentMethodList[0].last4.should.equal(CC_NUMBER.substr(CC_NUMBER.length-4));
                            r.paymentMethodList[0].status.should.equal('Valid');
                            r.paymentMethodList[0].customerId.should.not.equal(null);

                            r.transactionList.length.should.equal(2);

                            r.transactionList[0].amount.should.equal(0);
                            r.transactionList[0].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[0].transactionId.should.not.equal(null);
                            r.transactionList[0].transactionStatus.should.equal('Failed');
                            expect(r.transactionList[0].errorMessage).to.equal(null);

                            r.transactionList[1].amount.should.equal(66);
                            r.transactionList[1].paymentGatewayId.should.equal(r.paymentMethodList[0].paymentGatewayId);
                            r.transactionList[1].transactionId.should.not.equal(null);
                            r.transactionList[1].transactionStatus.should.equal('Completed');
                            r.transactionList[1].paymentStatus.should.equal('Captured');

                            done();
                        } catch(e) {
                            done(e);
                        }
                    });                    
                }).timeout(TIMEOUT_MS); 

            });


        }); // end of all mocha tests

        mocha.run();

	</script>
</body>
</html>